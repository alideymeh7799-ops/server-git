import{u as te,j as e,D as re,E as ie,F as de,G as ne,H as oe,B as E,e as v,s as le,i as ce,a3 as he,d as I,C as L}from"./index-Bt7t-uRm.js";import{u as me}from"./use-request-B4L2sB-F.js";import{r as o}from"./vendor-core-CiUIJZ_7.js";import{c as K}from"./converted-time-Dpp4WfBk.js";import{u as ue,b as p}from"./user-ReaFp5d6.js";import{F as xe,a as S,b as C,e as w,c as A}from"./form-B1s-44fp.js";import{I as _e}from"./input-D4IfRxCz.js";import{p as ge}from"./persian-OLrIT8M7.js";import{D as fe,p as be}from"./index-CkzAM18b.js";import{u as je}from"./index.esm-BGUB25Qb.js";import{v as ke,F as M,s as y}from"./vendor-ui-DnFwFa5O.js";import"./vendor-utils-IiNHtr66.js";function pe({title:b,show:x,formValue:n,onOk:h,onCancel:c,dataPayment:t,dataYegan:N}){const[f,T]=o.useState(n.yegan_id||void 0),{locale:G}=te(),[j,D]=o.useState(n?.date_takhsis||""),l=je({defaultValues:n,mode:"onChange"});o.useEffect(()=>{l.reset(n),D(n?.date_takhsis||""),T(n.yegan_id||void 0)},[n,l]);const B=a=>{if(t.baghi_mande&&Number(a.amount_takhsis)>t.baghi_mande){l.setError("amount_takhsis",{type:"manual",message:"مبلغ بیشتر از حد مجاز می‌باشد"});return}if(!f){l.setError("yegan_id",{type:"manual",message:"انتخاب یگان الزامی است"});return}if(!j){l.setError("date_takhsis",{type:"manual",message:"تاریخ تخصیص الزامی است"});return}const m={...a,yegan_id:f?Number(f):null,date_takhsis:j};h(m,n.id?"edit":"add")};return e.jsx(re,{open:x,onOpenChange:a=>!a&&c(),children:e.jsxs(ie,{children:[e.jsx(de,{children:e.jsx(ne,{children:b})}),e.jsxs("div",{className:"p-3 mb-4 border rounded  text-sm leading-6",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"شماره برگه اعتبار:"})," ",t.dataItem.number_etebar]}),e.jsxs("p",{children:[e.jsx("strong",{children:"مبلغ کل:"})," ",t.kol&&t.kol.toLocaleString()," ریال"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"مبلغ اختصاص یافته:"})," ",t?.kharj_shode&&t.kharj_shode.toLocaleString()," ","ریال"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"باقی‌مانده:"})," ",t.baghi_mande&&t.baghi_mande.toLocaleString()," ","ریال"]})]}),e.jsx(xe,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(B),className:"space-y-4",style:{direction:G==="fa_IR"?"rtl":"ltr"},children:[e.jsx(S,{control:l.control,name:"amount_takhsis",rules:{required:"مبلغ تخصیص الزامی است",min:{value:1,message:"مبلغ تخصیص باید بزرگتر از صفر باشد"},validate:a=>!t?.baghi_mande&&t?.baghi_mande!==0?!0:a&&a<=t.baghi_mande||"مبلغ بیشتر از حد مجاز می‌باشد"},render:({field:a,fieldState:m})=>e.jsxs(C,{children:[e.jsx(w,{children:"مبلغ تخصیص"}),e.jsx(A,{children:e.jsx(ke,{className:"w-full",style:{width:"100%"},...a,value:a.value||null,onChange:i=>{a.onChange(i),typeof t?.baghi_mande=="number"&&i>t.baghi_mande?l.setError("amount_takhsis",{type:"manual",message:"مبلغ بیشتر از حد مجاز می‌باشد"}):l.clearErrors("amount_takhsis")},formatter:i=>`${i}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:i=>i?.replace(/\$\s?|(,*)/g,"")??""})}),m.error&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:m.error.message})]})}),e.jsx(S,{control:l.control,name:"sharh_takhsis",rules:{required:"شرح تخصیص الزامی است",minLength:{value:3,message:"شرح تخصیص باید حداقل 3 کاراکتر باشد"},maxLength:{value:200,message:"شرح تخصیص نباید بیش از 200 کاراکتر باشد"}},render:({field:a,fieldState:m})=>e.jsxs(C,{children:[e.jsx(w,{children:"شرح تخصیص"}),e.jsx(A,{children:e.jsx(_e,{...a,value:a.value||""})}),m.error&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:m.error.message})]})}),e.jsx(S,{control:l.control,name:"yegan_id",rules:{validate:()=>f!=null&&f!==0?!0:"انتخاب یگان الزامی است"},render:({field:a,fieldState:m})=>e.jsxs(C,{children:[e.jsx(w,{children:"یگان تخصیص‌یافته"}),e.jsx(A,{children:e.jsxs("select",{className:"w-full flex flex-col gap-2 px-2 py-1 border border-accent rounded-b-md",value:f||"",onChange:i=>{const g=i.target.value;T(g?Number(g):void 0),a.onChange(g?Number(g):void 0)},children:[e.jsx("option",{value:"",children:"انتخاب کنید"}),N.map((i,g)=>e.jsx("option",{className:"w-full bg-background text-accent-foreground flex items-center justify-start px-2 py-1",value:i.id,children:"  نام یگان » "+i.name+" کد یگان » "+i.code},g))]})}),m.error&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:m.error.message})]})}),e.jsx(S,{control:l.control,name:"date_takhsis",rules:{required:"تاریخ تخصیص الزامی است"},render:({field:a,fieldState:m})=>e.jsxs(C,{children:[e.jsx(w,{children:"تاریخ تخصیص"}),e.jsx(A,{children:e.jsx(fe,{calendar:ge,locale:be,className:"w-full custom-date-picker",value:j,onChange:i=>{D(i),a.onChange(i)},inputClass:"w-full rounded border px-3 py-2",calendarPosition:"bottom-right",format:"YYYY/MM/DD",placeholder:"تاریخ را انتخاب کنید"})}),m.error&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:m.error.message})]})}),e.jsxs(oe,{children:[e.jsx(E,{variant:"outline",className:"bg-error-darker/50 hover:bg-error-darker cursor-pointer text-shadow-white ",onClick:c,type:"button",children:"انصراف"}),e.jsx(E,{type:"submit",className:"text-common-white",variant:"default",disabled:!l.formState.isValid||l.formState.isSubmitting,children:n.id?"ویرایش":"افزودن"})]})]})})]})})}const Ee={active:"bg-primary/hover! hover:bg-primary/focus! text-primary!"};function Ne({dataSource:b,onEdit:x,onDelete:n,selectedTakhsisItem:h}){const c=t=>{le.warning("آیا از حذف  مطمئن هستید؟",{action:{label:"حذف",onClick:()=>{t.id&&n(t.id)}},cancel:{label:"لغو",onClick:()=>{}}})};return e.jsx(v,{children:e.jsx(M,{rowKey:"id",columns:[{title:"مبلغ تخصیص",dataIndex:"amount_takhsis",render:t=>t?t.toLocaleString():"-"},{title:"شرح تخصیص",dataIndex:"sharh_takhsis",render:t=>t||"-"},{title:"شناسه اعتبار",dataIndex:"add_credit_id",render:t=>t??"-"},{title:"تاریخ تخصیص",dataIndex:"date_takhsis",render:t=>t?K(t,"date"):"-"},{title:"یگان",dataIndex:"yegan",render:t=>t?.name?t.name:"-"},{title:"عملیات",render:(t,N)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(E,{className:"bg-primary/70 hover:bg-primary text-white font-bold",onClick:()=>x(h,N),children:"ویرایش"}),e.jsx(E,{className:"bg-error/70 hover:bg-error text-white font-bold",onClick:()=>c(N),children:"حذف"})]})}],dataSource:b,pagination:!1,size:"small"})})}const Te={add_credit_id:null,amount_takhsis:null,date_takhsis:null,sharh_takhsis:null,yegan_id:null};function ye(){const b=ue(),{t:x}=ce(),{operationList:n,resourceList:h}=he,[c,t]=o.useState({show:!1,title:"ثبت تخصیص جدید",formValue:Te}),[N,f]=o.useState([]),[T,G]=o.useState([]),[j,D]=o.useState([]),[l,B]=o.useState([]),[a,m]=o.useState(null),[i,g]=o.useState(null),[R,U]=o.useState(Date.now()),[$,V]=o.useState([]),[u,z]=o.useState({kol:0,baghi_mande:0,kharj_shode:0}),k=me(),F=k.useGetData(p(h.CREDITBUDGET,n.GETALL)),H=k.useGetData(p(h.YEGAN,n.GETALL)),Y=k.useGetData(p(h.ADDCREDITS,n.GETALL)),O=k.useGetData(p(h.TAKHSISETEBAR,n.GETALL));o.useEffect(()=>{let s=!1;!s&&b.can(h.YEGAN,n.GETALL)&&(H.fetchData(),s=!0)},[]),o.useEffect(()=>{const s=H.data;s?.success&&s.data&&V(s.data)},[H.data]),o.useEffect(()=>{b.can(h.CREDITBUDGET,n.GETALL)&&(F.fetchData(),Y.fetchData())},[]);const J=async(s,r)=>{let d;const _=s.date_takhsis?new Date(s.date_takhsis).toISOString():null;r==="add"?d=await W.sendData({add_credit_id:Number(c.dataItem.id),amount_takhsis:Number(s.amount_takhsis),date_takhsis:_??null,sharh_takhsis:s.sharh_takhsis??null,yegan_id:Number(s.yegan_id)??null}):d=await Q.sendData({add_credit_id:Number(c.dataItem.id),amount_takhsis:Number(s.amount_takhsis),date_takhsis:_??null,sharh_takhsis:s.sharh_takhsis??null,yegan_id:Number(s.yegan_id)??null}),d?(r==="add"?y.success("با موفقیت اضافه  شد"):y.info("با موفقیت ویرایش شد"),U(Date.now())):y.error("خطا در ارسال اطلاعات"),t(ae=>({...ae,show:!1}))};o.useEffect(()=>{b.can(h.TAKHSISETEBAR,n.GETALL)&&O.fetchData()},[R,i]),o.useEffect(()=>{const s=F.data;s?.success&&s.data&&f(s.data);const r=Y.data;r?.success&&r.data&&G(r.data)},[F.data,Y]),o.useEffect(()=>{const s=O.data;s?.success&&s.data&&(D(s.data),i&&B(s.data.filter(r=>r.add_credit_id===i.id)))},[i,R]);const Q=k.useUpdateData(p(h.TAKHSISETEBAR,n.UPDATE,c.id)),W=k.usePostData(p(h.TAKHSISETEBAR,n.CREATE)),q=[{title:x("credits.credit_budget_origin.culoumns_header.radif"),dataIndex:"radif",key:"radif"},{title:x("credits.credit_budget_origin.culoumns_header.program"),key:"barname",render:(s,r)=>r.barname?.code??"-"},{title:x("credits.credit_budget_origin.culoumns_header.faliat"),key:"faaliat",render:(s,r)=>r.faaliat?.code??"-"},{title:x("credits.credit_budget_origin.culoumns_header.madeh"),dataIndex:"madeh",key:"madeh"},{title:x("credits.credit_budget_origin.culoumns_header.sharh_hazineh"),dataIndex:"payment_description",key:"payment_description"},{title:x("credits.credit_budget_origin.culoumns_header.sharhe_program"),key:"sharhe_program",render:(s,r)=>r.barname?.code??"-"},{title:x("credits.credit_budget_origin.culoumns_header.sharh_faliat"),key:"sharh_faliat",render:(s,r)=>r.faaliat?.code??"-"},{title:x("credits.credit_budget_origin.culoumns_header.noeEtebar"),dataIndex:"noe_etebar",key:"noe_etebar"}],X={title:"عملیات",key:"action",render:(s,r)=>e.jsx("div",{className:"flex gap-1 items-center justify-center",children:e.jsx(E,{onClick:()=>{m(r),g(null)},className:"bg-chart2/50 hover:bg-chart2 text-white font-bold ",variant:"outline",children:"مشاهده"})})},Z=b.can(h.CREDITBUDGET,n.GETALL)?[...q,X]:q;o.useEffect(()=>{if(T){const s=T||[],r=[];s.forEach(d=>{d.credit_budget_id&&d.credit_budget_id===a.id&&r.push(d)}),r.forEach(d=>{d&&d.credit_budget_id===a?.id&&z(_=>({..._,kol:d.amount_etebar?_.kol+d?.amount_etebar:0,baghi_mande:d.amount_etebar?_.kol+d?.amount_etebar:0}))})}},[a]),o.useEffect(()=>{if(j){const s=j||[],r=[];s.forEach(d=>{d.add_credit_id&&i?.credit_budget_id===a.id&&r.push(d)}),r.forEach(d=>{d&&d.add_credit_id===i?.id&&a?.id===i.credit_budget_id&&z(_=>({..._,baghi_mande:d.amount_takhsis?_.kol-d?.amount_takhsis:_.kol,kharj_shode:d.amount_takhsis?_.kharj_shode+d?.amount_takhsis:0}))})}},[j,i,R]);const P=(s,r)=>{t(d=>({...d,dataItem:s,show:!0,id:r.id,baghi_mande:u.kol-u.kharj_shode,kol:u.kol,kharj_shode:u.kharj_shode,formValue:r}))},ee=k.useDeleteData(p(h.TAKHSISETEBAR,n.DELETE)),se=async s=>{try{let r;r=await ee.remove("/"+s.toString()),r?.success?(y.success("با موفقیت حذف شد"),U(Date.now())):y.error("خطا در حذف")}catch(r){y.error(r.status==="500"?"خطا در ارتباط با سرور":"خطایی رخ داده است")}};return e.jsxs(e.Fragment,{children:[e.jsx(I,{children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h1",{className:"text-lg font-semibold",children:"تخصیص اعتبارات بودجه ای"})})}),e.jsxs(v,{children:[e.jsx(M,{rowKey:"id",size:"middle",rowClassName:s=>a?.id===s.id?Ee.active:"",columns:Z,dataSource:N,scroll:{x:"max-content"}}),a&&e.jsxs("div",{className:"mt-6 space-y-6",children:[e.jsxs(L,{className:"bg-background shadow-sm",children:[e.jsx(I,{children:e.jsxs("div",{className:"text-lg font-semibold",children:["اطلاعات ردیف اعتبار","  "+a.radif]})}),e.jsx(v,{children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"ردیف اعتبار : "}),a.radif]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:" تاریخ برگه اعتبار: "}),K(new Date().toISOString(),"date")]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"نوع اعتبار"}),a.noe_etebar]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"ماده اعتبار"}),a.madeh]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"برنامه اعتبار"}),a.barname?.code+"  "+a.barname?.description]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"فعالیت اعتبار"}),a.faaliat?.code+"  "+a.faaliat?.description]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"نوع اعتبار"}),a.noe_etebar]}),i?.id&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"مبلغ اعتبار: "}),Number(u.kol).toLocaleString()," ریال"]}),i?.id&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"خرج شده اعتبار: "}),Number(u.kharj_shode).toLocaleString()," ریال"]}),i?.id&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"باقی‌مانده اعتبار: "}),Number(u.kol-u.kharj_shode).toLocaleString()," ","ریال"]})]})})]}),e.jsxs(L,{children:[e.jsx(I,{children:e.jsxs("div",{className:"text-lg font-semibold",children:["لیست برگ های اعتبار ","  "+a.radif]})}),e.jsx(v,{children:e.jsx(M,{rowKey:"id",columns:[{title:"شماره برگ اعتبار",dataIndex:"number_etebar"},{title:"تاریخ برگ اعتبار",dataIndex:"date_etebar",render:s=>K(s,"date")},{title:x("non_credits.mablagh"),dataIndex:"amount_etebar",render:s=>Number(s).toLocaleString()+" ریال  "},{title:"  یگان واگذار ",dataIndex:"yegan_vagozar_id"},{title:x("non_credits.actions"),render:(s,r)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(E,{onClick:()=>{t(d=>({...d,dataItem:r,show:!0,baghi_mande:u.kol-u.kharj_shode,kol:u.kol,kharj_shode:u.kharj_shode})),g(r)},className:"flex items-center cursor-pointer justify-center px-4 py-1 text-sm font-medium font-iransans bg-chart4/50 hover:bg-chart4 text-white rounded-md transition-colors",children:"تخصیص اعتبار"}),e.jsx(E,{onClick:()=>{g(r)},className:"flex items-center cursor-pointer justify-center px-4 py-1 text-sm font-medium font-iransans bg-primary/50 hover:bg-primary text-white rounded-md transition-colors",children:"تخصیص یافته ها"})]})}],dataSource:T.filter(s=>s.credit_budget_id===a.id),pagination:!1,size:"small"})})]}),i&&e.jsxs(L,{children:[e.jsx(I,{children:e.jsxs("div",{className:"text-lg font-semibold",children:["اعتبارات تخصیص یافته برای برگ اعتبار"," شماره :  "+i.number_etebar]})}),e.jsx(v,{children:e.jsx(Ne,{dataSource:l,onDelete:se,onEdit:P,selectedTakhsisItem:i})})]})]})]}),c.show&&e.jsx(pe,{formValue:c.formValue,onCancel:()=>t(s=>({...s,show:!1})),dataPayment:{baghi_mande:u.baghi_mande,dataItem:c.dataItem,kharj_shode:u.kharj_shode,kol:u.kol,formValue:c.formValue,title:c.title,show:c.show},onOk:J,show:c.show,title:c.title,dataYegan:$})]})}function He(){return e.jsx(L,{children:e.jsx(ye,{})})}export{He as default};
