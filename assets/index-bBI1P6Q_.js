import{j as e,d as ne,B as M,a3 as le,e as re}from"./index-Bt7t-uRm.js";import{u as de}from"./use-request-B4L2sB-F.js";import{u as ie,b as A}from"./user-ReaFp5d6.js";import{r as t}from"./vendor-core-CiUIJZ_7.js";import{M as z,I as K,F,S,e as x}from"./vendor-ui-DnFwFa5O.js";import{c as $}from"./converted-time-Dpp4WfBk.js";import{p as q}from"./persian-OLrIT8M7.js";import{D as B,p as Y}from"./index-CkzAM18b.js";function ce({open:l,onClose:d,onSelect:n,peymanKarList:u}){const[o,s]=t.useState(""),f=t.useMemo(()=>u.filter(m=>!m||!m.name||!m.number_hesab?!1:m.name.includes(o)||String(m.number_hesab).includes(o)),[o,u]),i=[{title:"نام",dataIndex:"name",key:"name"},{title:"شماره حساب",dataIndex:"number_hesab",key:"number_hesab"},{title:"عملیات",key:"actions",render:(m,_)=>e.jsx("a",{onClick:()=>{n(_),d()},children:"انتخاب"})}];return e.jsxs(z,{title:"انتخاب حساب بانکی",open:l,onCancel:d,footer:null,children:[e.jsx(K,{placeholder:"جستجو بر اساس نام یا شماره حساب",value:o,onChange:m=>s(m.target.value),className:"mb-4"}),e.jsx(F,{rowKey:"id",dataSource:f,columns:i,size:"small"})]})}const oe=({yegan:l})=>e.jsx("div",{className:"mb-6 space-y-4 bg-muted/40 p-6 rounded-2xl shadow-sm border",children:e.jsx("div",{className:"flex flex-col md:flex-row justify-between gap-4",children:e.jsx("div",{className:"w-full flex items-center justify-between gap-2",children:e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"font-bold mr-6 text-destructive text-2xl",children:["یگان انتخاب شده: ",l[0].name+" "+l[0].code]})})})})}),he=({selectedUnit:l,onUnitChange:d,dataYegan:n})=>{const{Option:u}=S;return e.jsx(ne,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-3xl font-semibold",children:"لیست تنخواه "}),e.jsx(S,{className:"w-56",placeholder:"انتخاب یگان مورد نظر",value:l,onChange:d,allowClear:!0,children:n.map((o,s)=>e.jsx(u,{value:o.id,children:o.name+" کد یگان » "+o.code},s))})]})})};function me({dataSource:l,selectedRow:d,setSelectedRow:n,openCreateNewTankhahModal:u}){const o=[{title:"مبلغ تخصیص",dataIndex:"amount_takhsis",render:s=>s?s.toLocaleString():"-"},{title:"شرح تخصیص",dataIndex:"sharh_takhsis",render:s=>s||"-"},{title:"شناسه اعتبار",dataIndex:"add_credit_id",render:s=>s??"-"},{title:"تاریخ تخصیص",dataIndex:"date_takhsis",render:s=>s?$(s,"date"):"-"},{title:"یگان",dataIndex:"yegan",render:s=>s?.name?s.name:"-"},{title:"عملیات",render:()=>e.jsx("div",{className:"flex gap-2",children:e.jsx(M,{className:"bg-primary-dark/80 hover:bg-primary-dark cursor-pointer text-white font-bold ",onClick:()=>{u()},children:"ثبت تنخواه"})})}];return e.jsx("div",{children:e.jsx(F,{rowKey:"id",size:"small",scroll:{x:"max-content"},pagination:{pageSize:5},columns:o,onRow:s=>({onClick:()=>n(d?.id!==s.id?s:null),style:{cursor:"pointer",backgroundColor:d?.id===s.id?"bg-primary":void 0}}),dataSource:l})})}const ue=({title:l,show:d,formValue:n,onOk:u,handleModalSubmitNaghdPardhakht:o,onCancel:s,onAccountModalOpen:f,dataAmeleKharid:i,selectedRow:m,allAmount:_})=>{const[b]=x.useForm(),[g,w]=t.useState(n?.paymentType||""),[j,E]=t.useState(n?.amel_kharid_id?Number(n.amel_kharid_id):void 0),[L,P]=t.useState(""),[p,r]=t.useState(""),[h,y]=t.useState(n?.date_tankhah||null),[T,R]=t.useState(!0);t.useEffect(()=>{b.setFieldsValue(n),w(n?.paymentType||""),E(n?.amel_kharid_id?Number(n.amel_kharid_id):void 0),y(n?.date_tankhah||null),n?.accountNumber&&P(n.accountNumber),n?.accountOwner&&r(n.accountOwner)},[n,b]),t.useEffect(()=>{(async()=>{try{if(g==="tankhah"){if(await b.validateFields(["paymentType","amel_kharid_id","amount","description"]),!h)throw new Error("تاریخ پرداخت باید انتخاب شود")}else if(g==="cash"){if(await b.validateFields(["paymentType","amount","description"]),!h)throw new Error("تاریخ پرداخت باید انتخاب شود")}else throw new Error("نوع پرداخت باید انتخاب شود");R(!1)}catch{R(!0)}})()},[b,g,j,h]);const v=c=>{P(c.accountNumber),r(c.accountOwner)},D=c=>{const H=n?.id?"edit":"add";if(g==="cash"){const I={amount:c.amount,description:c.description,date_pardakht:h,peymankar_id:4};o(I,H)}else{const I={...c,amel_kharid_id:j,date_tankhah:h};u(I,H)}};return e.jsxs(z,{title:l,open:d,onCancel:s,footer:null,width:800,children:[m?.amount_takhsis&&e.jsxs("div",{className:"w-full p-4 bg-gradient-to-r mb-2 from-primary/60 to-primary/90 text-foreground rounded-lg shadow-lg flex justify-between items-center space-x-6 rtl:flex-row-reverse",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm opacity-75",children:"مبلغ برگ اعتبار"}),e.jsxs("span",{className:"text-lg ",children:[m.amount_takhsis.toLocaleString()+"  ","ريال"]})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm opacity-75",children:"باقیمانده"}),e.jsxs("span",{className:"text-lg ",children:[(m.amount_takhsis-_).toLocaleString()+"  ","ريال"]})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm opacity-75",children:"تنخواه ثبت شده"}),e.jsxs("span",{className:"text-lg ",children:[_.toLocaleString()+"  ","ريال"]})]})]}),e.jsxs(x,{form:b,layout:"vertical",onFinish:D,initialValues:n,className:"grid grid-cols-12 gap-4",children:[e.jsx(x.Item,{name:"paymentType",label:"نوع پرداخت",className:"col-span-12 md:col-span-6",rules:[{required:!0,message:"نوع پرداخت را انتخاب کنید"}],children:e.jsxs(S,{placeholder:"انتخاب کنید",onChange:c=>w(c),value:g,children:[e.jsx(S.Option,{value:"tankhah",children:"تنخواه"}),e.jsx(S.Option,{value:"cash",children:"نقد پرداخت"})]})}),g==="tankhah"&&e.jsxs(e.Fragment,{children:[e.jsx(x.Item,{name:"amel_kharid_id",label:"عامل خرید",className:"col-span-12 md:col-span-6",rules:[{required:!0,message:"عامل خرید را انتخاب کنید"}],children:e.jsx(S,{placeholder:"انتخاب کنید",onChange:c=>E(c),value:j,children:i.map(c=>e.jsxs(S.Option,{value:c.id,children:[c.number_hesab," ",c.onvan_hesab]},c.id))})}),e.jsx(x.Item,{name:"amount",label:"مبلغ پرداختی",className:"col-span-12 md:col-span-6",rules:[{required:!0,message:"مبلغ را وارد کنید"}],children:e.jsx(K,{type:"number"})}),e.jsx(x.Item,{name:"description",label:"شرح سند",className:"col-span-12",children:e.jsx(K,{})}),e.jsx(x.Item,{label:"تاریخ پرداخت",className:"col-span-12 md:col-span-6",children:e.jsx(B,{value:h,onChange:y,calendar:q,locale:Y,style:{width:"100%",height:"50px"}})})]}),g==="cash"&&e.jsxs(e.Fragment,{children:[e.jsx(x.Item,{name:"amount",label:"مبلغ تخصیص",className:"col-span-12 md:col-span-6",rules:[{required:!0,message:"مبلغ را وارد کنید"}],children:e.jsx(K,{type:"number"})}),e.jsx(x.Item,{name:"description",label:"شرح تخصیص",className:"col-span-12",children:e.jsx(K,{})}),e.jsx(x.Item,{label:"شماره حساب کاربر",className:"col-span-12",children:e.jsx(M,{className:"w-full",onClick:()=>f(v),children:L?`شماره: ${L} | مالک: ${p}`:"انتخاب شماره حساب"})}),e.jsx(x.Item,{label:"تاریخ پرداخت",className:"col-span-12 md:col-span-6",children:e.jsx(B,{value:h,onChange:y,calendar:q,locale:Y,style:{width:"100%",height:"50px"}})})]}),e.jsxs(x.Item,{className:"col-span-12 flex justify-end gap-3",children:[e.jsx(M,{className:"px-5 py-2 rounded-md ml-2 border-gray-300 text-white bg-error/50 hover:bg-error",onClick:s,children:"انصراف"}),e.jsx(M,{type:"submit",className:"px-5 py-2 rounded-md text-white bg-success/70 hover:bg-success",disabled:T,children:n?.id?"ویرایش":"افزودن"})]})]})]})},pe=[{title:"مبلغ پرداختی",dataIndex:"amount",key:"amount",render:l=>l?l.toLocaleString():"-"},{title:"شرح تنخواه",dataIndex:"description",key:"description"},{title:"تاریخ تنخواه",dataIndex:"date_tankhah",key:"date_tankhah",render:l=>l?$(l,"date"):"-"}],xe=({selectedRow:l,dataSource:d})=>{const n=t.useRef(null),[u,o]=t.useState(0);return t.useEffect(()=>{const s=d.reduce((f,i)=>f+(i.amount||0),0);o(s)},[d]),e.jsxs("div",{className:"bg-muted/30 border rounded-xl shadow-sm p-4 space-y-2",children:[e.jsx("h3",{className:"font-semibold text-base text-gray-700 mb-2",children:"لیست تنخواه پرداختی"}),e.jsxs("div",{ref:n,className:"w-full",children:[e.jsx(F,{rowKey:(s,f)=>`tankhah-${f}`,size:"small",columns:pe,dataSource:d,pagination:!1}),e.jsxs("div",{className:" text-primary   pt-2 border-t mt-2",children:["جمع کل تنخواه:",Number(u).toLocaleString(),"  ریال "]})]})]})},O={amount:null,date_tankhah:null,description:null};function Ae(){const l=ie(),[d,n]=t.useState(),[u,o]=t.useState([]),[s,f]=t.useState(!1),[i,m]=t.useState(null),[_,b]=t.useState(null),[g,w]=t.useState(Date.now()),[j,E]=t.useState({show:!1,title:"افزودن تنخواه جدید",formValue:O}),[L,P]=t.useState([]),{operationList:p,resourceList:r}=le,h=de(),y=h.useGetData(A(r.TAKHSISETEBAR,p.GETALL)),[T,R]=t.useState({yegan:[],amleKharid:[],peymanKar:[]}),v=h.useGetData("api/getMany?resources="+r.YEGAN+","+r.AMELE_KHARID+","+r.PEYMANKAR),D=h.useGetData(A(r.TANKHAH,p.GETALL)),c=h.useGetData(A(r.NAGDPARDAKHT,p.GETALL)),H=h.usePostData(A(r.TANKHAH,p.CREATE)),I=h.useUpdateData(A(r.TANKHAH,p.UPDATE,j.formValue.id)),J=h.usePostData(A(r.NAGDPARDAKHT,p.CREATE)),Q=h.useUpdateData(A(r.NAGDPARDAKHT,p.UPDATE,j.formValue.id));t.useEffect(()=>{l.can(r.TAKHSISETEBAR,p.GETALL)&&y.fetchData()},[]),t.useEffect(()=>{l.can(r.NAGDPARDAKHT,p.GETALL)&&l.can(r.TANKHAH,p.GETALL)&&D.fetchData()},[g]),t.useEffect(()=>{const a=y.data;a?.success&&a.data&&P(a.data)},[y.data]),t.useEffect(()=>{const a=D.data;a?.success&&a.data&&o(a.data)},[c.data,D.data]),t.useEffect(()=>{l.can(r.YEGAN,p.GETALL)&&v.fetchData()},[]),t.useEffect(()=>{const a=v.data;a?.success&&a.data&&R({yegan:a.data[r.YEGAN],amleKharid:a.data[r.AMELE_KHARID],peymanKar:a.data[r.PEYMANKAR]})},[v.data]);const W=async(a,C,k="tankhah")=>{let N;const U=a.date_tankhah?new Date(a.date_tankhah).toISOString():null;k&&(C==="add"?N=await H.sendData({amel_kharid_id:Number(a.amel_kharid_id),amount:Number(a.amount),date_tankhah:U,takhsis_etebar_id:i?.id,description:a.description}):N=await I.sendData({amel_kharid_id:Number(a.amel_kharid_id),amount:Number(a.amount),date_tankhah:U,takhsis_etebar_id:i?.id,description:a.description})),N&&w(Date.now()),G()},X=async(a,C)=>{let k;const N=a.date_pardakht?new Date(a.date_pardakht).toISOString():null;C==="add"?k=await J.sendData({peymankar_id:Number(a.peymankar_id),amount:Number(a.amount),date_pardakht:N,takhsis_etebar_id:i?.id,description:a.description}):k=await Q.sendData({peymankar_id:Number(a.peymankar_id),amount:Number(a.amount),date_pardakht:N,takhsis_etebar_id:i?.id,description:a.description}),k&&w(Date.now()),G()},Z=a=>{n(a),m(null)},V=a=>{b(()=>a),f(!0)},ee=a=>{_&&_(a),f(!1),b(null)},ae=()=>{E({show:!0,title:"افزودن تنخواه جدید",formValue:O})},G=()=>{E({show:!1,title:"افزودن تنخواه جدید",formValue:O})},[te,se]=t.useState(0);return t.useEffect(()=>{if(i?.amount_takhsis){const a=[];u.forEach(k=>{k.takhsis_etebar_id===i.id&&a.push(k)});const C=a.reduce((k,N)=>k+(N.amount||0),0);se(C)}},[i]),e.jsxs(e.Fragment,{children:[e.jsx(he,{selectedUnit:d,dataYegan:T.yegan,onUnitChange:Z}),e.jsx(re,{children:d&&e.jsxs(e.Fragment,{children:[e.jsx(oe,{yegan:T?.yegan.filter(a=>a.id===Number(d))}),e.jsx(ue,{title:j.title,show:j.show,formValue:j.formValue,onOk:W,handleModalSubmitNaghdPardhakht:X,onCancel:G,onAccountModalOpen:V,dataAmeleKharid:T.amleKharid,selectedRow:i,allAmount:te}),e.jsx(me,{dataSource:L.filter(a=>a.yegan_id===Number(d)),openCreateNewTankhahModal:ae,selectedRow:i,setSelectedRow:m}),i&&e.jsx("div",{className:"mt-8 space-y-8",children:e.jsx(xe,{selectedRow:i,dataSource:u.filter(a=>a.takhsis_etebar_id===i.id)})})]})}),s&&e.jsx(ce,{peymanKarList:T.peymanKar,open:s,onClose:()=>{f(!1),b(null)},onSelect:ee})]})}export{Ae as A};
